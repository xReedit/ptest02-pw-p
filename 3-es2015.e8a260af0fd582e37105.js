(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{"3ui4":function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));class s{constructor(){this.secciones=[]}}},"6NNB":function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));class s{constructor(){this.tipoconsumo=[]}}},Ie24:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));class s{constructor(){this.descuento=null,this.items=[]}}},JOr0:function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));var s=i("qTE5"),o=i("+lji"),c=i("HDdC"),a=i("fXoL");let r=(()=>{class e{constructor(e){this.crudService=e,this.keyStorage="sys::ed"}set(e){localStorage.setItem(this.keyStorage,btoa(JSON.stringify(e)))}get(){let e=new s.a;const t=localStorage.getItem(this.keyStorage);return e=t?JSON.parse(atob(t)):e,e}setRulesSubtotales(e){this.establecimiento=this.get(),this.establecimiento.rulesSubTotales=e,this.set(this.establecimiento)}setCostoSercioDelivery(e){this.establecimiento=this.get(),this.establecimiento.costo_total_servicio_delivery=e,this.set(this.establecimiento)}loadEstablecimientoById(e){this.crudService.postFree({idsede:e},"delivery","get-establecimientos").subscribe(e=>{this.establecimiento=e.data[0],this.set(this.establecimiento)})}getFindDirClienteCacheEstableciemto(e,t){let i=null,s=this.getEstableciminetosCache();return s=s.filter(t=>t.idcliente_pwa_direccion===e.idcliente_pwa_direccion)[0],s&&(s=s?s.listEstablecimientos:[],i=s.filter(e=>e.idsede===t.idsede)[0]),i}getEstableciminetosCache(){const e=localStorage.getItem("sys:ech");return e?JSON.parse(atob(e)):[]}setEstableciminetosCache(e){const t=this.getEstableciminetosCache(),i=t.filter(t=>t.idcliente_pwa_direccion===e.idcliente_pwa_direccion)[0];i?(e.listEstablecimientos.map(e=>{let t=i.listEstablecimientos.filter(t=>t.idsede===e.idsede)[0];t?t=e:i.listEstablecimientos.push(e)}),e.listEstablecimientos=i.listEstablecimientos):t.push(e),localStorage.setItem("sys:ech",btoa(JSON.stringify(t)))}getComsionEntrega(){const e=this.get();1===e.pwa_delivery_hablitar_calc_costo_servicio&&this.crudService.postFree({codigo_postal:e.codigo_postal},"pedido","get-last-comsion-entrega-sede",!1).subscribe(t=>{const i=t.data[0];e.c_minimo=i.c_minimo,e.c_km=i.c_km,this.set(e)})}getClienteAutocomplete(e){const t={buscar:e};return new c.a(e=>{this.crudService.postFree(t,"pedido","get-find-cliente-by-name",!0).subscribe(t=>{e.next(t.data)})})}getComerciosXCalifcar(e){const t={idcliente:e};return new c.a(e=>{this.crudService.postFree(t,"delivery","get-comercio-x-calificar",!1).subscribe(t=>{e.next(t.data)})})}setRegisterScanQr(e,t,i=0){this.crudService.postFree({idsede:e,canal:t,idscan:i},"pedido","register-scan",!1).subscribe(e=>{console.log("register-scan",e),this.setLocalIdScanQr(e.data[0].idscanqr)})}setLocalIdScanQr(e){localStorage.setItem("sys::scan",e.toString())}getLocalIdScanQr(){const e=localStorage.getItem("sys::scan")||"0";return parseInt(e,0)}}return e.\u0275fac=function(t){return new(t||e)(a.Vb(o.a))},e.\u0275prov=a.Hb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})()},Te6q:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));class s{constructor(){this.precio_total=0,this.precio_antes=null,this.cantidad_seleccionada_x_tpc=0,this.cantidad_descontado=0,this.itemtiposconsumo=[],this.subitems_selected=[],this.subitems_view=[]}}},WF5t:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var s=i("7RJT"),o=i("zOUh"),c=i("fXoL");let a=(()=>{class e{constructor(e){this.infoToken=e,this.countdownTimerRef=null,this.init=0,this.valPorcentaje=0,this.isPlayTimer=!1,this.dateNow=new Date,this.countdownSource=new s.BehaviorSubject(0),this.countdown$=this.countdownSource.asObservable(),this.isTimeLimitSource=new s.BehaviorSubject(!1),this.isTimeLimitComplet$=this.isTimeLimitSource.asObservable(),this.isPorgressVisibleSource=new s.BehaviorSubject(!1),this.isPorgressVisible$=this.isPorgressVisibleSource.asObservable()}destroy(){this.clearTimeout()}playCountTimerLimit(){this.infoToken.isDelivery()||this.isPlayTimer||(this.isPlayTimer=!0,this.initCount())}resetCountTimerLimit(){this.infoToken.isDelivery()||(localStorage.getItem("sys::tcount")?(this.isPlayTimer=!0,this.initCount()):this.stopCountTimerLimit())}initCount(){this.infoToken.isDelivery()||(this.valPorcentaje=0,this.init=localStorage.getItem("sys::tcount")?parseInt(localStorage.getItem("sys::tcount"),0):0,this.isTimeLimitSource.next(!1),this.isPorgressVisibleSource.next(!0),this.progressCount())}progressCount(){let e=0;this.isPlayTimer&&(this.countdownTimerRef=setTimeout(()=>{this.init=this.setTimeDate(),this.valPorcentaje=Math.round(this.init/this.maxTime*100),localStorage.setItem("sys::tcount",this.init.toString()),this.init>this.maxTime?(this.init=this.maxTime,this.valPorcentaje=100,this.countdownSource.next(this.valPorcentaje),this.isTimeLimitSource.next(!0),this.stopCountTimerLimit()):(e!==this.valPorcentaje&&this.countdownSource.next(this.valPorcentaje),this.progressCount()),e=this.valPorcentaje},1e3))}setTimeDate(){const e=(new Date).getTime(),t=localStorage.getItem("sys::tnum")?parseInt(localStorage.getItem("sys::tnum"),0):e,i=Math.floor((e-t)/1e3);return localStorage.setItem("sys::tnum",t.toString()),i}stopCountTimerLimit(){this.isPlayTimer=!1,this.init=0,this.valPorcentaje=0,localStorage.removeItem("sys::tcount"),localStorage.removeItem("sys::tnum"),this.clearTimeout(),this.isPorgressVisibleSource.next(!1),this.isTimeLimitSource.next(!1)}clearTimeout(){this.countdownTimerRef&&(clearTimeout(this.countdownTimerRef),this.countdownTimerRef=null)}}return e.\u0275fac=function(t){return new(t||e)(c.Vb(o.a))},e.\u0275prov=c.Hb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})()},fbMX:function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var s=i("fXoL");let o=(()=>{class e{constructor(){}set(e,t){localStorage.setItem(e,t)}get(e){return localStorage.getItem(e)}isExistKey(e){return!!localStorage.getItem(e)}clear(e){localStorage.removeItem(e)}}return e.\u0275fac=function(t){return new(t||e)},e.\u0275prov=s.Hb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})()},nx09:function(e,t,i){"use strict";i.d(t,"a",(function(){return C}));var s=i("7RJT"),o=i("Te6q"),c=i("6NNB");class a{}var r=i("Ie24"),n=i("3ui4"),d=i("fbMX"),m=i("yFR0"),l=i("WF5t"),u=i("/sn2"),p=i("wne+"),h=i("eI2u");class S{constructor(){this.isTpcLocal=!1,this.isTpcSoloLLevar=!1,this.isTpcSoloDelivery=!1,this.isTpcSoloOther=!1,this.isRequiereMesa=!1}}class b{}var _=i("JOr0"),v=i("+lji"),g=i("zOUh"),f=i("fXoL"),I=i("dNgK");let C=(()=>{class e{constructor(e,t,i,a,n,d,m,l,u,p){this.storageService=e,this.socketService=t,this.timerLimitService=i,this.navigatorService=a,this._snackBar=n,this.utilesService=d,this.listenStatusService=m,this.establecimientoService=l,this.crudService=u,this.infoTokenService=p,this.miPedidoSource=new s.BehaviorSubject(new c.a),this.miPedidoObserver$=this.miPedidoSource.asObservable(),this.countItemsSource=new s.BehaviorSubject(0),this.countItemsObserve$=this.countItemsSource.asObservable(),this.itemStockChangeSource=new s.BehaviorSubject(new o.a),this.itemStockChangeObserve$=this.itemStockChangeSource.asObservable(),this.isPreAvisoVisible=!1,this.listItemsPedido=[],this.miPedido=new c.a,this.mpObjSeccionSelected=new r.a,this.time=new Date,this.pwa_delivery_servicio_propio=!1,this.deliveryCanItemsInOrder=0,this.deliveryArrConstantes={cantItemsScala:0,costoScala:0}}getObjCarta(){return this.objCarta}getObjCartaLibery(){return JSON.parse(JSON.stringify(this.objCarta))}setObjMiPedido(e){this.miPedido=e,this.miPedidoSource.next(this.miPedido)}resetObjMiPedido(){this.miPedido=new c.a,this.miPedidoSource.next(this.miPedido)}setObjCarta(e){this.objCarta={},this.objCarta={carta:null,bodega:null},this.objCarta.carta=e[0].carta,this.objCarta.bodega=e[0].bodega;let t=this.objCarta.carta;const i=this.objCarta.bodega;if(i){if(!this.objCarta.carta){const e=new a;return e.des="Productos",e.detalle="",e.hora_fin="",e.hora_ini="",e.idcarta=0,e.idcategoria=0,e.secciones=[],t=[],t.push(e),t.map(e=>{i.map(t=>{e.secciones.push(t)})}),void(this.objCarta.carta=t)}t.map(e=>{i.map(t=>{e.secciones.push(t)})})}}setObjCartaDescuentos(e){if(this.infoTokenService.infoUsToken.isHayDescuento=!1,0===e.length)return;if(1===e[0].solo_app&&!this.infoTokenService.infoUsToken.isCliente)return;this.infoTokenService.infoUsToken.isHayDescuento=!0;let t=0;e.map(e=>{switch(e.tipo){case 0:this.objCarta.carta.map(i=>{i.secciones.map(i=>{const s=i.items.filter(t=>t.iditem.toString()===e.id)[0];if(s)return t=e.porcentaje,s.iddescuento=e.idsede_descuento,this.aplicarDescuentoImte(s,t),!1})});break;case 1:t=e.porcentaje,this.objCarta.carta.map(i=>{i.secciones.map(i=>{i.idseccion.toString()===e.id&&(i.descuento=t+"%",i.iddescuento=e.idsede_descuento,i.items.map(e=>{this.aplicarDescuentoImte(e,t)}))})});break;case 2:t=e.porcentaje,this.objCarta.bodega.map(i=>{const s=i.items.filter(t=>t.iditem.toString()===e.id)[0];if(s)return t=e.porcentaje,s.iddescuento=e.idsede_descuento,this.aplicarDescuentoImte(s,t),!1});break;case 3:t=e.porcentaje,this.objCarta.bodega.map(i=>{i.idseccion.toString()===e.id&&(i.descuento=t+"%",i.iddescuento=e.idsede_descuento,i.items.map(e=>{this.aplicarDescuentoImte(e,t)}))})}})}aplicarDescuentoImte(e,t){const i=parseFloat(e.precio),s=Math.round(i-i*(t/100));e.precio_antes=e.precio,e.precio=s.toString(),e.precio_default=s,e.precio_unitario=s.toString()}getIdsDescuentos(){let e;const t=[];return this.miPedido.tipoconsumo.map(i=>{i.secciones.map(i=>{e=i.iddescuento,e&&(t.filter(t=>t.id===e)[0]||t.push({id:e})),i.items.map(s=>{e=i.iddescuento,e&&(t.filter(t=>t.id===e)[0]||t.push({id:e}))})})}),t}getMiPedido(){return 0===this.miPedido.tipoconsumo.length&&this.storageService.isExistKey("sys::order::all")&&(this.miPedido=JSON.parse(atob(this.storageService.get("sys::order::all")))),this.miPedido}setobjItemTipoConsumoSelected(e){this.mpObjItemTipoConsumoSelected=e}setObjSeccionSeleced(e){this.mpObjSeccionSelected=new r.a,this.mpObjSeccionSelected.des=e.des,this.mpObjSeccionSelected.idimpresora=e.idimpresora,this.mpObjSeccionSelected.idseccion=e.idseccion,this.mpObjSeccionSelected.sec_orden=e.sec_orden,this.mpObjSeccionSelected.ver_stock_cero=e.ver_stock_cero,this.mpObjSeccionSelected.iddescuento=e.iddescuento,this.mpObjSeccionSelected.descuento=e.descuento}getDeliveryConstCantEscala(){const e=localStorage.getItem("sys::ICS");e?this.deliveryArrConstantes=JSON.parse(atob(e)):this.crudService.getAll("pedido","get-const-delivery-items-escala",!1,!1,!1).subscribe(e=>{this.deliveryArrConstantes={cantItemsScala:e.data[0].value,costoScala:e.data[1].value},localStorage.setItem("sys::ICS",btoa(JSON.stringify(this.deliveryArrConstantes)))})}addItem2(e,t,i=0,s=null){let o=parseInt(t.cantidad.toString(),0);const c=0===i;if(o<=0&&c)return;let a=e.cantidad_seleccionada||0;if(a+=c?1:-1,a<0)return;"ND"!==t.isporcion&&(o+=c?-1:1,a=a<0?0:a,o=o<0||a<0?0:o),a=a<0?0:a,e.cantidad_seleccionada=a;const r=JSON.parse(JSON.stringify(e)),n=this.findItemMiPedido(r,this.mpObjSeccionSelected,t,c);n.cantidad=o,s&&(t=this.findItemCarta(t)),t.sumar=c,t.subitems_selected=n.subitems_selected,t.subitems_view=n.subitems_view;const d=this.findItemListPedido(t);let m=1;d?(d.itemtiposconsumo||(d.itemtiposconsumo=this.mpObjItemTipoConsumoSelected),m=this.totalItemTpcSelected(d.itemtiposconsumo)||0,d.cantidad_seleccionada=m,d.subitems_selected=n.subitems_selected,d.subitems_view=n.subitems_view):this.listItemsPedido.push(t),t.cantidad_seleccionada=m,this.itemStockChangeSource.next(t),this.setLocalStorageHora(),this.setLocalStoragePedido(),this.socketService.emit("itemModificado",t),this.listenStatusService.setHayPedidoPendiente(!0),this.playTimerLimit()}totalItemTpcSelected(e){return e.map(e=>e.cantidad_seleccionada||0).reduce((e,t)=>e+t,0)}addCantItemMiPedido(e,t){const i=t,s=i*parseFloat(e.precio_unitario);e.subitems_selected&&e.subitems_selected.map(e=>e.precio*e.cantidad_seleccionada).reduce((e,t)=>e+t,0),e.cantidad_seleccionada=i,e.precio_total=s,e.precio_print=s}addPrecioItemMiPedido(e){const t=e.subitems_view?e.subitems_view.map(e=>e.precio).reduce((e,t)=>e+t,0):0;let i=e.cantidad_seleccionada*parseFloat(e.precio_unitario);i+=t,e.precio_total=i,e.precio_print=i}addItemSubItemMiPedido(e,t,i){if(e.subitems){if(0===e.subitems.length)return;const t=new b;if(t.id="",t.des="",t.listDes=[],t.cantidad_seleccionada=0,t.precio=0,t.indicaciones="",t.subitems=[],e.subitems_selected&&e.subitems_selected.length>0){e.subitems_selected.map(e=>{t.id+=e.iditem_subitem.toString(),t.listDes.push(this.utilesService.primeraConMayusculas(e.des.toLowerCase())),t.cantidad_seleccionada=1,t.precio+=parseFloat(e.precio.toString()),t.subitems.push(e)}),t.des=t.listDes.join(", "),t.des+=void 0===e.indicaciones||""===e.indicaciones?"":", ("+e.indicaciones+")",e.indicaciones="",e.subitems_view=e.subitems_view?e.subitems_view:[];const s=e.subitems_view.filter(e=>e.id===t.id)[0];s?i?(s.indicaciones+=t.indicaciones,s.cantidad_seleccionada+=1,s.precio+=t.precio):this.restarCantSubItemView(e,s):i?e.subitems_view.push(t):this.restarCantSubItemView(e,null),this.addPrecioItemMiPedido(e)}}}restarCantSubItemView(e,t=null){if(t){const i=t.precio/t.cantidad_seleccionada;t.cantidad_seleccionada-=1,t.precio-=i,t.precio=t.precio<0?0:t.precio,t.cantidad_seleccionada<=0&&(e.subitems_view=e.subitems_view.filter(e=>e.cantidad_seleccionada>0))}else{const t=e.subitems_view[e.subitems_view.length-1],i=t.precio/t.cantidad_seleccionada;t.cantidad_seleccionada--,t.precio-=i,t.cantidad_seleccionada<=0&&(e.subitems_view=e.subitems_view.filter(e=>e.cantidad_seleccionada>0)),e.subitems_selected=t.subitems}}addItemInCarta(e){const t=this.findItemCarta(e);t?t.cantidad=t.cantidad:this.objCarta.carta.map(t=>{t.secciones.filter(t=>t.idseccion===e.idseccion).map(t=>{t.items.push(e)})})}findItemFromArr(e,t){return e.filter(e=>e.iditem===t.iditem)[0]}findItemListPedido(e){return this.listItemsPedido.filter(t=>t.iditem===e.iditem)[0]}findItemCartaAndClearIndicaciones(){this.objCarta.carta.map(e=>{e.secciones.map(e=>{e.items.filter(e=>e.indicaciones).map(e=>e.indicaciones=""),e.items.filter(e=>e.subitems_selected).map(e=>e.subitems_selected=null),e.items.filter(e=>e.subitems_view).map(e=>e.subitems_view=null)})})}findItemCarta(e){let t;return this.objCarta.carta.map(i=>{i.secciones.map(i=>{const s=i.items.filter(t=>t.idcarta_lista===e.idcarta_lista)[0];if(s)return t=s,t})}),t}findItemCartaByIdCartaLista(e){let t;return this.objCarta.carta.map(i=>{i.secciones.map(i=>{const s=i.items.filter(t=>t.idcarta_lista.toString()===e.toString())[0];if(s)return t=s,t})}),t}findSubItemCartaById(e,t){const i=[];return this.objCarta.carta.map(s=>{s.secciones.map(s=>{s.items.filter(e=>e.iditem.toString()!==t).filter(e=>e.subitems).map(t=>{t.subitems.map(t=>{const s=t.opciones.filter(t=>t.idproducto.toString()+t.idporcion.toString()===e)[0];s&&i.push(s)})})})}),i}resetCantidadesTpcItemCarta(){this.objCarta&&this.objCarta.carta.map(e=>{e.secciones.map(e=>{e.items.map(e=>{e.indicaciones="",e.cantidad_seleccionada=0,e.itemtiposconsumo=null})})})}findItemSeccionCarta(e){let t;return this.objCarta.carta.map(i=>{const s=i.secciones.filter(t=>t.idseccion===e)[0];s&&(t=s)}),t}findOnlyItemMiPedido(e){let t;return this.miPedido.tipoconsumo.map(i=>{i.secciones.map(i=>{t=i.items.filter(t=>t.idcarta_lista===e.idcarta_lista)[0]})}),t}findItemMiPedido(e,t,i,s){let o,c=JSON.parse(JSON.stringify(i));const a=e.cantidad_seleccionada;c.itemtiposconsumo=[],this.addCantItemMiPedido(c,a);const r=this.miPedido.tipoconsumo.filter(t=>t.idtipo_consumo===e.idtipo_consumo)[0];if(r){const e=r.secciones.filter(e=>e.idseccion===t.idseccion)[0];if(e){const t=e.items.filter(e=>e.idcarta_lista===i.idcarta_lista)[0];t?(t.indicaciones=c.indicaciones,this.addCantItemMiPedido(t,a),c=t,o=c):(e.items.push(c),o=c),c.subitems=i.subitems,c.subitems_selected=i.subitems_selected,this.addItemSubItemMiPedido(c,i,s),this.setCountCantItemTpcAndSeccion(r,e)}else{o=c;const e=JSON.parse(JSON.stringify(t));e.items=[],e.items.push(c),r.secciones=r.secciones?r.secciones:[],r.secciones.push(e),this.addItemSubItemMiPedido(c,i,s),this.setCountCantItemTpcAndSeccion(r,e)}}else{c.subitems=i.subitems,c.subitems_selected=i.subitems_selected,this.addItemSubItemMiPedido(c,i,s);const a=JSON.parse(JSON.stringify(t));a.items=[],a.items.push(c),e.secciones=e.secciones?e.secciones:[],e.secciones.push(a),this.miPedido.tipoconsumo.push(e),this.setCountCantItemTpcAndSeccion(e,a),o=c}return this.clearObjMiPedido(),o}quitarTpcMiPedido(e){1===e.count_items_seccion&&(this.miPedido.tipoconsumo=this.miPedido.tipoconsumo.filter(t=>!e))}quitarSeccionMiPedido(e){1===e.count_items&&this.miPedido.tipoconsumo.map(t=>{t.secciones.filter(t=>!e)})}findMiPedidoIsTPCLocal(){let e=!1;return this.miPedido.tipoconsumo.filter(e=>"LOCAL"===e.titulo).map(t=>{e=!!t.secciones.filter(e=>e.count_items>0)[0]}),e}findMiPedidoIsTPCDelivery(){let e=!1;return this.miPedido.tipoconsumo.filter(e=>"DELIVERY"===e.descripcion.toUpperCase()).map(t=>{e=!!t.secciones.filter(e=>e.count_items>0)[0]}),e}findMiPedidoIsTPCLLevar(){let e=!1;return this.miPedido.tipoconsumo.filter(e=>e.descripcion.toUpperCase().indexOf("LLEVAR")).map(t=>{e=!!t.secciones.filter(e=>e.count_items>0)[0]}),e}findEvaluateTPCMiPedido(){const e=new S;let t=0;return this.miPedido.tipoconsumo.filter(e=>e.count_items_seccion>0).map(i=>{"LOCAL"===i.titulo&&(e.isTpcLocal=!0,t++),i.descripcion.toUpperCase().indexOf("LLEVAR")>-1&&(e.isTpcSoloLLevar=!0,t++),i.descripcion.toUpperCase().indexOf("DELIVERY")>-1&&(e.isTpcSoloDelivery=!0),e.isRequiereMesa=!!e.isTpcLocal,e.isTpcSoloLLevar=!(1!==t||!e.isTpcSoloLLevar)}),e}findSeccionInMipedidoByPrint(e){let t;return this.miPedido.tipoconsumo.map(i=>{t=i.secciones.filter(t=>t.idimpresora===e)}),t}findIsHayItems(){return this.setCountTotalImtesPedido()>0}clearObjMiPedido(){if(this.miPedido.tipoconsumo=this.miPedido.tipoconsumo.filter(e=>e.count_items_seccion>0),0===this.miPedido.tipoconsumo.length)return this.miPedido=new c.a,void this.miPedidoSource.next(this.miPedido);this.miPedido.tipoconsumo=this.miPedido.tipoconsumo.map(e=>(e.secciones=e.secciones.filter(e=>e.count_items>0),e)),this.miPedido.tipoconsumo=this.miPedido.tipoconsumo.map(e=>(e.secciones=e.secciones.map(e=>(e.items=e.items.filter(e=>e.cantidad_seleccionada>0),e)),e)),this.miPedidoSource.next(this.miPedido)}setCountCantItemTpcAndSeccion(e,t){const i=t.items.map(e=>e.cantidad_seleccionada).reduce((e,t)=>e+t,0);t.count_items=i;const s=e.secciones.map(e=>e.count_items).reduce((e,t)=>e+t,0);e.count_items_seccion=s,this.setCountTotalImtesPedido()}setCountTotalImtesPedido(){const e=this.miPedido.tipoconsumo.map(e=>e.count_items_seccion).reduce((e,t)=>e+t,0);return this.countItemsSource.next(e),e}setLocalStorageHora(){if(this.storageService.isExistKey("sys::h"))return;const e=`${this.time.getHours()}:${this.time.getMinutes()}:${this.time.getSeconds()}`;this.storageService.set("sys::h",e.toString())}setLocalStoragePedido(){this.storageService.set("sys::order",btoa(JSON.stringify(this.listItemsPedido))),this.storageService.set("sys::order::all",btoa(JSON.stringify(this.miPedido)))}clearPedidoIsLimitTime(){this.storageService.isExistKey("sys::order")&&(this.listItemsPedido=JSON.parse(atob(this.storageService.get("sys::order"))),this.miPedido=JSON.parse(atob(this.storageService.get("sys::order::all"))))}resetAllNewPedido(){this.socketService.emit("resetPedido",this.listItemsPedido),this.prepareNewPedido()}prepareNewPedido(){this.resetTpcCarta(),this.storageService.clear("sys::h"),this.storageService.clear("sys::order"),this.storageService.clear("sys::order::all"),this.storageService.clear("sys::tcount"),this.storageService.clear("sys::tnum"),this.miPedido=null,this.miPedido=new c.a,this.miPedidoSource.next(this.miPedido),this.countItemsSource.next(0),this.listenStatusService.setHayPedidoPendiente(!1),this.stopTimerLimit()}getOnlyCarta(){this.socketService.emit("getOnlyCarta",null)}resetTpcCarta(){try{this.listItemsPedido.map(e=>{if(e.indicaciones="",!e.itemtiposconsumo)return;e.itemtiposconsumo=null;const t=this.findItemCarta(e);t.indicaciones="",t.cantidad_seleccionada=0,t.itemtiposconsumo=null})}catch(e){}this.resetCantidadesTpcItemCarta(),this.listItemsPedido=[]}updatePedidoFromStrorage(){this.listenStatusService.setHayPedidoPendiente(!1),this.storageService.isExistKey("sys::order")&&(this.listenStatusService.setHayPedidoPendiente(!0),this.listItemsPedido=JSON.parse(atob(this.storageService.get("sys::order"))),this.miPedido=JSON.parse(atob(this.storageService.get("sys::order::all"))),this.setCountTotalImtesPedido(),this.miPedidoSource.next(this.miPedido),this.listItemsPedido.map(e=>{this.objCarta.carta.map(t=>{t.secciones.map(t=>{const i=t.items.filter(t=>t.idcarta_lista===e.idcarta_lista)[0];i&&(i.cantidad_seleccionada=e.cantidad_seleccionada,i.itemtiposconsumo=e.itemtiposconsumo)})})}))}updatePedidoFromClear(){this.listItemsPedido&&(this.listItemsPedido.map(e=>{0===e.isalmacen&&this.objCarta.carta.map(t=>{t.secciones.map(t=>{const i=t.items.filter(t=>"ND"!==t.isporcion&&t.idcarta_lista===e.idcarta_lista)[0];i&&(i.cantidad=parseInt(i.cantidad.toString(),0)+e.cantidad_seleccionada)})})}),this.prepareNewPedido())}getEstadoStockItem(e){return e>10?"verde":e>5?"amarillo":"rojo"}validarReglasCarta(e){let t=0,i=0,s=0,o=0,c=0,a=0,r=0;this.miPedido.tipoconsumo.map(e=>{e.secciones.map(e=>{e.items.map(e=>e.precio_total_calc=null)})}),e.map(e=>{t=e.idseccion,i=e.idseccion_detalle,s=this.countCantItemsFromSeccion(t),o=this.countCantItemsFromSeccion(i),c=s-o,c=c<0?s:c,this.miPedido.tipoconsumo.map(e=>{e.secciones.filter(e=>e.idseccion.toString()===i.toString()).map(e=>{e.items.map((e,t)=>{const i=parseFloat(e.precio),n=e.cantidad_seleccionada;r=null!==e.precio_total_calc?e.precio_total_calc:e.precio_total,a=r,s>=o?a=0:c>0&&(a=c*i,a=r-a,a=a<0?0:a,c=c-n<0?0:c-n),e.precio_total_calc=parseFloat(a.toString()),e.precio_print=parseFloat(a.toString()),e.cantidad_descontado=n})})})})}countCantItemsFromSeccion(e){let t=0;return this.miPedido.tipoconsumo.map(i=>{i.secciones.map(i=>{t+=i.items.filter(t=>t.idseccion.toString()===e.toString()).map(e=>e.cantidad_seleccionada).reduce((e,t)=>e+t,0)})}),t}countCantItemsFromTpcSeccion(e,t){let i=0;return this.miPedido.tipoconsumo.filter(t=>t.idtipo_consumo.toString()===e.toString()).map(e=>{e.secciones.map(e=>{i+=e.items.filter(e=>e.idseccion.toString()===t.toString()).map(e=>e.cantidad_seleccionada).reduce((e,t)=>e+t,0)})}),i}countCantItemsFromTpc(e){let t=0;return this.miPedido.tipoconsumo.filter(t=>t.idtipo_consumo.toString()===e.toString()).map(e=>{e.secciones.map(e=>{t+=e.items.map(e=>e.cantidad_seleccionada).reduce((e,t)=>e+t,0)})}),t}countCantItemsFromTpcDes(e){let t=0;return this.miPedido.tipoconsumo.filter(t=>t.descripcion.toLowerCase()===e.toLowerCase()).map(e=>{e.secciones.map(e=>{t+=e.items.map(e=>e.cantidad_seleccionada).reduce((e,t)=>e+t,0)})}),t}getArrSubTotales(e){const t=this.getSubTotalMiPedido(),i=1===this.establecimientoService.establecimiento.pwa_delivery_hablitar_calc_costo_servicio,s=this.establecimientoService.establecimiento.pwa_delivery_comision_fija_no_afiliado,o=1===this.establecimientoService.establecimiento.pwa_delivery_comercio_paga_entrega;this.pwa_delivery_servicio_propio=1===this.establecimientoService.establecimiento.pwa_delivery_servicio_propio;let c=t;const a=[];let r={id:0,descripcion:"SUB TOTAL",esImpuesto:0,visible:!0,quitar:!1,tachado:!1,visible_cpe:!0};r.importe=parseFloat(t.toString()).toFixed(2),a.push(r);const n=[];e.filter(e=>"p"===e.tipo).map(e=>{const i=e.monto/100,s=1===e.es_impuesto,o=0===e.activo,a=(t*i).toFixed(2),r={};r.id=e.tipo+e.id,r.descripcion=e.descripcion,r.esImpuesto=e.es_impuesto,r.visible=!0,r.quitar=!1,r.tachado=!1,r.visible_cpe=s,"I.G.V"===r.descripcion?(r.importe=o?i:0,n.push(r)):(r.importe=s?o?a:0:a,r.importe=parseFloat(r.importe.toString()).toFixed(2),c+=parseFloat(r.importe)),0!==r.importe&&n.push(r)});let d=0;const m=[],l=e.filter(e=>"a"===e.tipo);let u=!this.infoTokenService.infoUsToken.idusuario,p=!1,h=!0,S=!1;const b=this.countCantItemsFromTpcDes("delivery")+this.countCantItemsFromTpcDes("entrega")+this.countCantItemsFromTpcDes("cantidad");if(S=b>0,d=this.establecimientoService.get().c_servicio||this.establecimientoService.get().c_minimo,l.map(e=>{const t={};if((e.descripcion.toUpperCase().indexOf("DELIVERY")>-1||e.descripcion.toUpperCase().indexOf("ENTREGA")>-1)&&u){if(h=!0,p=!0,e.descripcion="Entrega",!this.pwa_delivery_servicio_propio||i){S=!0,p=!1,d=this.establecimientoService.get().c_servicio||this.establecimientoService.get().c_minimo;const t=this.countCantItemsFromTpc(e.idtipo_consumo);return u=t>0,void(h=t>0)}d=parseFloat(e.monto)}else d=parseFloat(e.monto);if(0===this.countCantItemsFromTpc(e.idtipo_consumo))return;if(0===e.nivel){const t=this.countCantItemsFromTpcSeccion(e.idtipo_consumo,e.idseccion);if(0===t)return;const i=this.calcCostoCantItemsDelivery();d=t*parseFloat(e.monto)+i}t.id=e.tipo+e.id,t.descripcion=e.descripcion,t.esImpuesto=e.es_impuesto,t.visible=!0,t.quitar=!0,t.tachado=!1,t.visible_cpe=!1,t.importe=parseFloat(d.toString()).toFixed(2),c+=parseFloat(t.importe);const s=m.filter(e=>e.descripcion===t.descripcion)[0];s?s.importe+=parseFloat(t.importe):m.push(t)}),S){const e={},t=this.calcCostoCantItemsDelivery()+(this.establecimientoService.get().c_servicio||this.establecimientoService.get().c_minimo)+s;this.establecimientoService.setCostoSercioDelivery(t),!o&&i&&(e.id=-2,e.descripcion="Entrega",e.isDeliveryApp=!0,e.esImpuesto=0,e.visible=!0,e.quitar=!0,e.tachado=!1,e.visible_cpe=!1,e.importe=parseFloat(t.toString()).toFixed(2),c+=parseFloat(e.importe),m.push(e))}n.map(e=>a.push(e)),m.map(e=>a.push(e));const _=a.filter(e=>"SUB TOTAL"===e.descripcion)[0],v=a.filter(e=>"I.G.V"===e.descripcion)[0];let g=v?v.importe:0,f=_?_.importe:0;return g>0&&(g=parseFloat((f*g).toString()).toFixed(2),f-=g,v.importe=g,_.importe=f.toFixed(2)),r={},r.id=0,r.esImpuesto=0,r.descripcion="TOTAL",r.visible=!0,r.quitar=!1,r.tachado=!1,r.visible_cpe=!0,r.importe=parseFloat(c.toString()).toFixed(2),a.push(r),a}calcCostoCantItemsDelivery(){let e=0;const t=parseInt(this.deliveryArrConstantes.cantItemsScala.toString(),0);if(this.deliveryCanItemsInOrder>t){const t=this.deliveryCanItemsInOrder/this.deliveryArrConstantes.cantItemsScala;t>1&&(e=Math.floor(t)*this.deliveryArrConstantes.costoScala)}else e=0;return e}getSubTotalMiPedido(){let e=0,t=0;return this.miPedido.tipoconsumo.map(i=>{i.secciones.map(i=>{e+=i.items.map(e=>(t+=e.cantidad_seleccionada,e.precio_print)).reduce((e,t)=>e+t,0)})}),this.deliveryCanItemsInOrder=t,e}getImporteTotalItemFromMiPedido(e){let t=0;return this.miPedido.tipoconsumo.map(i=>{i.secciones.map(i=>{t+=i.items.filter(t=>t.iditem===e.iditem).map(e=>e.precio_print).reduce((e,t)=>e+t,0)})}),t}playTimerLimit(){this.timerLimitService.playCountTimerLimit()}stopTimerLimit(){this.timerLimitService.resetCountTimerLimit()}restoreTimerLimit(){this.timerLimitService.resetCountTimerLimit()}listenChangeCantItem(){this.socketService.onItemModificado().subscribe(e=>{let t;if(null!=e.listItemPorcion)e.listItemPorcion.map(i=>{t=this.findItemCartaByIdCartaLista(i.idcarta_lista);const s=parseInt(i.cantidad,0);t.cantidad=s||parseInt(e.item.cantidad.toString(),0),this.setCantidadItemModificadoPwa(e.item,t,parseInt(i.cantidad,0),!0)});else{if(!e.item)return;t=this.findItemCarta(e=e.item),this.setCantidadItemModificadoPwa(e,t)}}),this.socketService.onItemResetCant().subscribe(e=>{let t;null!=e.listItemPorcion?e.listItemPorcion.map(i=>{t=this.findItemCartaByIdCartaLista(i.idcarta_lista),t.cantidad=parseInt(i.cantidad,0),this.setCantidadItemModificadoPwa(e.item,t,parseInt(i.cantidad,0),!0),this.itemStockChangeSource.next(t)}):(t=this.findItemCarta(e=e.item),t.cantidad=parseInt(e.cantidad.toString(),0),t.subitems=e.subitems,this.itemStockChangeSource.next(t))}),this.socketService.onNuevoItemAddInCarta().subscribe(e=>{this.addItemInCarta(e)}),this.socketService.onGetDatosSede().subscribe(e=>{this.objDatosSede=e[0],this.objDatosSede.datossede[0].longitude=parseFloat(this.objDatosSede.datossede[0].longitude),this.objDatosSede.datossede[0].latitude=parseFloat(this.objDatosSede.datossede[0].latitude),this.listenStatusService.setHayDatosSede(!0),localStorage.setItem("sys::s",this.objDatosSede.datossede[0].nombre+"|"+this.objDatosSede.datossede[0].ciudad),console.log("datos de la sede ps",this.objDatosSede),this.max_minute_order=e[0].datossede[0].pwa_time_limit,this.pwa_delivery_servicio_propio=0!==e[0].datossede[0].pwa_delivery_servicio_propio,this.timerLimitService.maxTime=100*this.max_minute_order}),this.timerLimitService.countdown$.subscribe(e=>{switch(e){case 1:this.isPreAvisoVisible=!1;break;case 80:this.isPreAvisoVisible||(this.isPreAvisoVisible=!0,this._snackBar.open("Proximo a cumplir el tiempo de envio.","",{duration:2e3}));break;case 100:this._snackBar.open("Tiempo agotado, debe realizar un nuevo pedido.","",{duration:3e3})}}),this.timerLimitService.isTimeLimitComplet$.subscribe(e=>{!0===e&&(this.resetAllNewPedido(),this.navigatorService.setPageActive("carta"))})}setCantidadItemModificadoPwa(e,t,i=null,s=!1){e.subitems&&e.idcarta_lista===t.idcarta_lista&&e.subitems.map(i=>{i.opciones.map(i=>{t.subitems.map(t=>{const s=t.opciones.filter(e=>e.iditem_subitem===parseInt(i.iditem_subitem.toString(),0))[0];if(s&&"ND"!==s.cantidad){s.cantidad=i.cantidad;const t=s.idproducto.toString()+s.idporcion.toString();this.findSubItemCartaById(t,e.iditem.toString()).map(e=>{e.cantidad=i.cantidad})}})})}),s||(t.cantidad=i||parseInt(e.cantidad.toString(),0)),this.itemStockChangeSource.next(t)}darFormatoPedido(e){const t=new c.a,i=[];return e.data.map(e=>{let t=i.filter(t=>t.idtipo_consumo===e.idtipo_consumo)[0];t||(t=new n.a,t.descripcion=e.des_tp,t.idtipo_consumo=parseInt(e.idtipo_consumo,0),i.push(t))}),i.map(t=>{e.data.filter(e=>e.idtipo_consumo===t.idtipo_consumo).map((e,i)=>{let s=t.secciones.filter(t=>t.idseccion.toString()===e.idseccion.toString())[0];s||(s=new r.a,s.idseccion=e.idseccion.toString(),s.des=e.des_seccion,s.sec_orden=e.sec_orden,s.ver_stock_cero=0,t.count_items_seccion=i+1,t.secciones.push(s))})}),i.map(t=>{t.secciones.map(i=>{e.data.filter(e=>e.idtipo_consumo.toString()===t.idtipo_consumo.toString()&&e.idseccion.toString()===i.idseccion.toString()).map((e,t)=>{const s=new o.a;s.des=e.descripcion,s.detalles="",s.iditem=e.iditem,s.idcarta_lista=e.idcarta_lista,s.idseccion=e.idseccion,s.isalmacen=e.isalmacen,s.cantidad_seleccionada=parseInt(e.cantidad,0),s.precio=e.punitario,s.precio_print=parseFloat(e.ptotal),s.precio_total=parseFloat(e.ptotal),s.procede="0"===e.procede?1:0,s.seccion=e.des_seccion,s.img=e.img,s.subitems_view="null"!==e.subitems&&""!==e.subitems&&e.subitems?JSON.parse(e.subitems):[],i.count_items=t+1,i.items=i.items?i.items:[],i.items.push(s)})})}),t.tipoconsumo=i,t}printerPrecuenta(e){this.crudService.postFree(e,"pedido","printer-precuenta",!0).subscribe(e=>{console.log("send-printer-precuenta",e)})}cerrarSession(){this.socketService.closeConnection(),this.navigatorService.cerrarSession()}}return e.\u0275fac=function(t){return new(t||e)(f.Vb(d.a),f.Vb(m.a),f.Vb(l.a),f.Vb(u.a),f.Vb(I.a),f.Vb(p.a),f.Vb(h.a),f.Vb(_.a),f.Vb(v.a),f.Vb(g.a))},e.\u0275prov=f.Hb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})()},qTE5:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));class s{}}}]);